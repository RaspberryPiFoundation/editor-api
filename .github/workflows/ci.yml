name: CI

on:
  pull_request:
  push:

permissions:
  contents: read

env:
  BUNDLE_JOBS: '3'
  BUNDLE_RETRY: '3'
  PAGER: ''

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Install lint dependencies
        run: sudo apt-get update && sudo apt-get install --yes --no-install-recommends libpq-dev

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .tool-versions
          bundler-cache: true

      - name: Run RuboCop
        run: bundle exec rubocop --format progress

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      pull-requests: write
    env:
      RAILS_ENV: test
      POSTGRES_DB: choco_cake_test
      POSTGRES_PASSWORD: password
      POSTGRES_USER: choco
      POSTGRES_HOST: 127.0.0.1
      POSTGRES_PORT: '5432'
      REDIS_URL: redis://127.0.0.1:6379/1
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: primary-key
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: deterministic-key
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: derivation-salt
      EDITOR_ENCRYPTION_KEY: a1b2c3d4e5f67890123456789abcdef0123456789abcdef0123456789abcdef0
    services:
      postgres:
        image: postgres:12
        env:
          POSTGRES_DB: choco_cake_test
          POSTGRES_PASSWORD: password
          POSTGRES_USER: choco
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U choco -d choco_cake_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:6.2-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Install test dependencies
        run: sudo apt-get update && sudo apt-get install --yes --no-install-recommends libpq-dev postgresql-client jq curl imagemagick

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .tool-versions
          bundler-cache: true

      - name: Set up Firefox
        id: setup_firefox
        continue-on-error: true
        uses: browser-actions/setup-firefox@v1

      - name: Set up Chrome fallback
        if: steps.setup_firefox.outcome == 'failure'
        uses: browser-actions/setup-chrome@v1

      - name: Select system test browser
        run: |
          if [ "${{ steps.setup_firefox.outcome }}" = "success" ]; then
            echo "SYSTEM_TEST_BROWSER=firefox" >> "$GITHUB_ENV"
            echo "Using Firefox for system tests"
          else
            echo "SYSTEM_TEST_BROWSER=chrome" >> "$GITHUB_ENV"
            echo "Falling back to Chrome for system tests"
          fi

      - name: Wait for DB
        run: |
          until pg_isready -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" -U "$POSTGRES_USER"; do
            sleep 1
          done

      - name: Database setup
        run: bin/rails db:setup --trace

      - name: Run test suite
        run: bundle exec rspec

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage
          if-no-files-found: ignore

      - name: Build coverage comment
        if: always() && github.event_name == 'pull_request'
        id: coverage_comment
        run: |
          coverage='unavailable'
          if [ -s coverage/.last_run.json ]; then
            coverage=$(jq -r 'if .result.line then .result.line else .result.covered_percent end' coverage/.last_run.json)
          fi

          if [ -z "$coverage" ] || [ "$coverage" = 'null' ]; then
            coverage='unavailable'
          fi

          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$coverage" = 'unavailable' ]; then
            message="### Test coverage
SimpleCov coverage data was unavailable for this run.
Run: $run_url"
          else
            message="### Test coverage
$coverage% line coverage reported by SimpleCov.
Run: $run_url"
          fi

          {
            echo "message<<'EOF'"
            echo "$message"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Comment coverage on PR
        if: always() && github.event_name == 'pull_request'
        continue-on-error: true
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: simplecov-coverage
          message: ${{ steps.coverage_comment.outputs.message }}
