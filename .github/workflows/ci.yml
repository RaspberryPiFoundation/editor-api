name: CI

on:
  pull_request:
  push:

permissions:
  contents: read

env:
  BUNDLE_JOBS: '3'
  BUNDLE_RETRY: '3'
  PAGER: ''

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    container:
      image: ruby:3.4

    steps:
      - uses: actions/checkout@v4

      - name: Install lint dependencies
        run: apt-get update && apt-get install --yes --no-install-recommends build-essential git libpq-dev pkg-config

      - name: Run RuboCop
        run: bundle install && bundle exec rubocop --format progress

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    container:
      image: ruby:3.4
    permissions:
      contents: read
      issues: write
      pull-requests: write
    env:
      RAILS_ENV: test
      POSTGRES_DB: choco_cake_test
      POSTGRES_PASSWORD: password
      POSTGRES_USER: choco
      POSTGRES_HOST: postgres
      POSTGRES_PORT: '5432'
      REDIS_URL: redis://redis:6379/1
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: primary-key
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: deterministic-key
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: derivation-salt
      EDITOR_ENCRYPTION_KEY: a1b2c3d4e5f67890123456789abcdef0123456789abcdef0123456789abcdef0
    services:
      postgres:
        image: postgres:12
        env:
          POSTGRES_DB: choco_cake_test
          POSTGRES_PASSWORD: password
          POSTGRES_USER: choco
        options: >-
          --health-cmd="pg_isready -U choco -d choco_cake_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:6.2-alpine

    steps:
      - uses: actions/checkout@v4

      - name: Install test dependencies
        run: >
          apt-get update && apt-get install --yes --no-install-recommends
          build-essential git libpq-dev pkg-config postgresql-client jq curl imagemagick firefox-esr chromium

      - name: Select system test browser
        run: |
          if command -v firefox >/dev/null 2>&1; then
            echo "SYSTEM_TEST_BROWSER=firefox" >> "$GITHUB_ENV"
            echo "Using Firefox for system tests"
          else
            echo "Firefox unavailable; falling back to Chrome"
            echo "SYSTEM_TEST_BROWSER=chrome" >> "$GITHUB_ENV"
            chrome_bin="$(command -v google-chrome || command -v chromium || command -v chromium-browser || true)"
            if [ -z "$chrome_bin" ]; then
              echo "Chrome fallback requested, but no Chrome binary is available"
              exit 1
            fi
            echo "CHROME_BIN=$chrome_bin" >> "$GITHUB_ENV"
          fi

      - name: Wait for DB
        run: |
          until pg_isready -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" -U "$POSTGRES_USER"; do
            sleep 1
          done

      - name: Install gems
        run: bundle install

      - name: Database setup
        run: bin/rails db:setup --trace

      - name: Run test suite
        run: bundle exec rspec

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage
          if-no-files-found: ignore

      - name: Build coverage comment
        if: always() && github.event_name == 'pull_request'
        id: coverage_comment
        run: |
          coverage='unavailable'
          if [ -s coverage/.last_run.json ]; then
            coverage=$(jq -r 'if .result.line then .result.line else .result.covered_percent end' coverage/.last_run.json)
          fi

          if [ -z "$coverage" ] || [ "$coverage" = 'null' ]; then
            coverage='unavailable'
          fi

          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$coverage" = 'unavailable' ]; then
            message="### Test coverage
SimpleCov coverage data was unavailable for this run.
Run: $run_url"
          else
            message="### Test coverage
$coverage% line coverage reported by SimpleCov.
Run: $run_url"
          fi

          {
            echo "message<<'EOF'"
            echo "$message"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Comment coverage on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          COVERAGE_MESSAGE: ${{ steps.coverage_comment.outputs.message }}
        with:
          script: |
            const marker = '<!-- simplecov-coverage -->';
            const body = `${marker}\n${process.env.COVERAGE_MESSAGE}`;
            const issue_number = context.payload.pull_request.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              per_page: 100
            });

            const existing = comments.find((comment) =>
              comment.user?.type === 'Bot' && comment.body?.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body
              });
            }
